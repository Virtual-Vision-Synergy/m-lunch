{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restaurants - M'Lunch</title>
  <link rel="stylesheet" href="{% static 'css/map.css' %}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
 
</head>
<body class="page-container">
  <!-- HEADER -->
  <header class="site-header">
    <div class="overlap-wrapper">
      <div class="overlap-2">
        <div class="group-8">
          <div class="overlap-group-3">
            <img class="rectangle-4" src="{% static 'img/icones/logo.png' %}" alt="Logo" />
            <div class="group-11">
              <a href="{% url 'frontoffice_index' %}" class="text-wrapper-10">Accueil</a>
              <a href="{% url 'mes_commandes' %}" class="text-wrapper-11">Commandes</a>
              <a href="{% url 'restaurant_list' %}" class="text-wrapper-12">Restaurant</a>
              <a href="#about" class="text-wrapper-12">A propos</a>
            </div>
            <div class="icons-right">
              <a href="login.html" class="icon-button"><img src="{% static 'img/icones/user.svg' %}" alt="Profil" /></a>
              <a href="panier.html" class="icon-button"><img src="{% static 'img/icones/panier.svg' %}" alt="Panier" /></a>
              <button class="icon-button" id="menu-toggle"><img src="{% static 'img/icones/menu.svg' %}" alt="Menu" /></button>

              <nav id="hamburger-menu" class="hamburger-menu">
                <ul>
                  <li class="has-submenu">
                    <a href="#">Commande <span class="arrow">&#x2304;</span></a>
                    <ul class="submenu">
                      <li><a href="en_cours.html">En Cours</a></li>
                      <li><a href="historique.html">Historique</a></li>
                    </ul>
                  </li>
                  <li><a href="panier.html">Panier</a></li>
                  <li><a href="#about">A propos</a></li>
                  <li><a href="{% url 'frontoffice_logout' %}">Deconnexion</a></li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="content-wrapper">
    <!-- ======= RESTAURANT MAP ======== -->
    <h1 class="restaurant-title">Restaurants autour de vous</h1>
    <p class="subtitle">D√©couvrez les meilleurs restaurants de votre r√©gion</p>

    <!-- Stats Section -->
    <div class="stats-section">
      <div class="stat-item">
        <span class="stat-number" id="restaurant-count">0</span>
        <span class="stat-label">Restaurants disponibles</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">100%</span>
        <span class="stat-label">Main-d‚Äô≈ìuvre locale</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">15-30</span>
        <span class="stat-label">Temps de livraison (min)</span>
      </div>
    </div>

    <div class="map-wrapper">
      <div class="map-controls">
        <button class="control-button" onclick="centerMap()" title="Centrer la carte">üéØ</button>
        <button class="control-button" onclick="toggleFullscreen()" title="Plein √©cran">‚õ∂</button>
      </div>
      <div id="map">
        <div class="loading-spinner" id="loading-spinner"></div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Initialize the map with restaurant functionality
    const map = L.map('map').setView([-18.8792, 47.5204], 13);
    let restaurantCount = 0;

    // Hide loading spinner once map is ready
    map.on('load', function() {
      document.getElementById('loading-spinner').style.display = 'none';
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Custom marker styling with better design
    const restaurantIcon = L.divIcon({
      className: 'restaurant-marker',
      html: `<div style="
        background: linear-gradient(45deg, #ff6b35, #f7931e);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        border: 3px solid white;
      ">üçΩÔ∏è</div>`,
      iconSize: [36, 36],
      iconAnchor: [18, 18]
    });

    // Map control functions
    function centerMap() {
      map.setView([-18.8792, 47.5204], 13);
    }

    function toggleFullscreen() {
      const mapElement = document.getElementById('map');
      if (!document.fullscreenElement) {
        mapElement.requestFullscreen().then(() => {
          setTimeout(() => map.invalidateSize(), 100);
        });
      } else {
        document.exitFullscreen().then(() => {
          setTimeout(() => map.invalidateSize(), 100);
        });
      }
    }

    // Load restaurants in GeoJSON format with enhanced popup
fetch('/api/restaurants/')
  .then(response => {
    console.log('Fetch /api/restaurants/ response:', response);
    return response.json();
  })
  .then(data => {
    console.log('Fetched restaurant data:', data);
    document.getElementById('loading-spinner').style.display = 'none';
    restaurantCount = data.features.length;
    document.getElementById('restaurant-count').textContent = restaurantCount;
    L.geoJSON(data, {
      onEachFeature: function (feature, layer) {
        const props = feature.properties;
        // Debug horaires for each restaurant
        console.log('Restaurant:', props.nom, 'Horaires:', props.horaires);
        // Get opening and closing times (first slot if exists)
        let horaireText = 'Horaire non renseign√©';
        if (props.horaires && props.horaires.length > 0) {
          const h = props.horaires[0];
          horaireText = `üïí ${h.horaire_debut} - ${h.horaire_fin}`;
        }
        const popupContent = `
          <div class="restaurant-popup">
            <strong>${props.nom}</strong>
            <div class="rating">${horaireText}</div>
            ${props.image_url ? `<img src="${props.image_url}" alt="${props.nom}">` : ''}
            <div style="margin: 10px 0; color: #666; font-size: 14px;">
              üìç ${props.adresse || 'Adresse non disponible'}
            </div>
            <a href="/menu/${props.id}/"><button class="menu-button">Voir le menu</button></a>
          </div>
        `;
        layer.bindPopup(popupContent, {
          maxWidth: 250,
          className: 'custom-popup'
        });
        layer.bindTooltip(props.nom, {
          direction: 'top',
          offset: [0, -20]
        });
      },
      pointToLayer: function (feature, latlng) {
        return L.marker(latlng, {
          icon: restaurantIcon
        });
      }
    }).addTo(map);
  })
      .catch(error => {
        console.error('Error loading restaurants:', error);
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('restaurant-count').textContent = '‚ö†Ô∏è';
        
        // Fallback marker if API fails
        const marker = L.marker([-18.8792, 47.5204], {
          icon: restaurantIcon
        }).addTo(map);
        marker.bindPopup(`
          <div class="restaurant-popup">
            <strong>Erreur de chargement</strong><br>
            <div style="color: #666; margin: 10px 0;">
              Impossible de charger les restaurants. Veuillez r√©essayer plus tard.
            </div>
            <button class="menu-button" onclick="location.reload()">R√©essayer</button>
          </div>
        `).openPopup();
      });

    // Enhanced hamburger menu functionality
    document.addEventListener('DOMContentLoaded', function() {
      const menuToggle = document.getElementById('menu-toggle');
      const hamburgerMenu = document.getElementById('hamburger-menu');
      const submenuParents = document.querySelectorAll('.has-submenu');

      // Open/close hamburger menu
      menuToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        hamburgerMenu.classList.toggle('active');
      });

      // Close menu when clicking elsewhere
      document.addEventListener('click', function(e) {
        if (!hamburgerMenu.contains(e.target) && e.target !== menuToggle) {
          hamburgerMenu.classList.remove('active');
        }
      });

      // Submenu handling
      submenuParents.forEach(function(parent) {
        parent.addEventListener('click', function(e) {
          e.stopPropagation();
          parent.classList.toggle('open');
        });
      });

      // Search clear functionality
      const clearSearch = document.querySelector('.group');
      if (clearSearch) {
        clearSearch.addEventListener('click', function() {
          document.querySelector('.search-input').value = '';
        });
      }

      // Add smooth scroll to map when page loads
      setTimeout(() => {
        document.querySelector('.map-wrapper').scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }, 500);
    });
  </script>
</body>
</html>