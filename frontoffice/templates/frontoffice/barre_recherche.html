<!-- frontoffice/barre_recherche.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche de Restaurants</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .search-form {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .search-button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .search-button:hover {
            background: #0056b3;
        }
        
        .results-info {
            margin: 10px 0;
            color: #666;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 8px 12px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .restaurant-popup {
            max-width: 250px;
        }
        
        .restaurant-popup img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        
        .restaurant-popup h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .restaurant-popup .address {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .menu-button {
            background: #28a745;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
        }
        
        .menu-button:hover {
            background: #218838;
        }
        
        .menu-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .restaurant-card {
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Recherche de Restaurants</h1>
        
        <!-- Formulaire de recherche -->
        <div class="search-container">
            <form method="post" class="search-form" id="searchForm">
                {% csrf_token %}
                
                <select name="secteur" class="search-input">
                    <option value="">-- Choisir un secteur --</option>
                    {% for zone in zones %}
                        <option value="{{ zone.nom }}" {% if zone.nom == secteur_recherche %}selected{% endif %}>
                            {{ zone.nom }}
                        </option>
                    {% endfor %}
                </select>
                
                <input type="text" name="nom" placeholder="Nom du restaurant..." 
                       value="{{ nom_recherche }}" class="search-input">
                
                <input type="text" name="adresse" placeholder="Adresse (rue, quartier)..." 
                       value="{{ adresse_recherche }}" class="search-input">
                
                <button type="submit" class="search-button">🔍 Rechercher</button>
            </form>
            
            {% if nb_resultats > 0 %}
                <div class="results-info">
                    📍 {{ nb_resultats }} restaurant{{ nb_resultats|pluralize }} trouvé{{ nb_resultats|pluralize }}
                    {% if user_zone %}
                        - Votre secteur : <strong>{{ user_zone }}</strong>
                    {% endif %}
                </div>
            {% elif secteur_recherche or nom_recherche or adresse_recherche %}
                <div class="results-info" style="color: #dc3545;">
                    ❌ Aucun restaurant trouvé pour votre recherche
                </div>
            {% endif %}
        </div>
        
        <!-- Carte -->
        <div id="map"></div>
        
        <!-- Liste des résultats -->
        {% if restaurants %}
            <div class="restaurants-list" style="margin-top: 20px;">
                <h3>📋 Résultats de la recherche</h3>
                {% for restaurant in restaurants %}
                    <div class="restaurant-card">
                        <h4>🏪 {{ restaurant.nom }}</h4>
                        <p>📍 {{ restaurant.adresse }}</p>
                        <p>🏷️ Zone: {{ restaurant.zone_nom|default:"Non définie" }}</p>
                        
                        {% if not restaurant.available_in_user_zone %}
                            <div class="warning-message">
                                ⚠️ Les offres de ce restaurant ne sont pas disponibles dans votre secteur ({{ user_zone }})
                            </div>
                        {% else %}
                            <a href="/restaurant/{{ restaurant.id }}/menu/" class="menu-button">
                                🍽️ Voir le menu
                            </a>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Initialiser la carte sur Antananarivo
        var map = L.map('map').setView([-18.8792, 47.5079], 12);
        
        // Ajouter les tuiles de la carte
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Données des restaurants depuis Django
        var restaurants = [
            {% for restaurant in restaurants %}
            {
                id: {{ restaurant.id }},
                nom: "{{ restaurant.nom|escapejs }}",
                adresse: "{{ restaurant.adresse|escapejs }}",
                image: "{{ restaurant.image|escapejs }}",
                latitude: {{ restaurant.latitude|default:0 }},
                longitude: {{ restaurant.longitude|default:0 }},
                zone_nom: "{{ restaurant.zone_nom|default:'Non définie'|escapejs }}",
                available_in_user_zone: {{ restaurant.available_in_user_zone|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        console.log('Restaurants trouvés:', restaurants.length);
        
        // Ajouter les marqueurs des restaurants
        var markers = [];
        restaurants.forEach(function(restaurant) {
            if (restaurant.latitude && restaurant.longitude && restaurant.latitude != 0 && restaurant.longitude != 0) {
                // Créer le contenu du popup
                var popupContent = `
                    <div class="restaurant-popup">
                        ${restaurant.image ? `<img src="${restaurant.image}" alt="${restaurant.nom}" onerror="this.style.display='none'">` : ''}
                        <h4>🏪 ${restaurant.nom}</h4>
                        <div class="address">📍 ${restaurant.adresse}</div>
                        <div class="address">🏷️ Zone: ${restaurant.zone_nom}</div>
                        ${!restaurant.available_in_user_zone ? 
                            `<div class="warning-message" style="margin: 8px 0; padding: 5px; font-size: 11px;">
                                ⚠️ Non disponible dans votre secteur
                             </div>` : ''}
                        <a href="/restaurant/${restaurant.id}/menu/" class="menu-button" 
                           ${!restaurant.available_in_user_zone ? 'style="background: #6c757d; cursor: not-allowed;" onclick="return false;"' : ''}>
                            🍽️ Voir le menu
                        </a>
                    </div>
                `;
                
                // Créer le marqueur
                var marker = L.marker([restaurant.latitude, restaurant.longitude])
                    .bindPopup(popupContent)
                    .bindTooltip(restaurant.nom, {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -20]
                    })
                    .addTo(map);
                
                // Changer l'opacité si non disponible
                if (!restaurant.available_in_user_zone) {
                    marker.setOpacity(0.6);
                }
                
                markers.push(marker);
            } else {
                console.log('Restaurant sans coordonnées:', restaurant.nom);
            }
        });
        
        // Ajuster la vue pour inclure tous les marqueurs
        if (markers.length > 0) {
            var group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        } else if (restaurants.length > 0) {
            console.log('Aucun restaurant avec coordonnées valides trouvé');
        }
    </script>
</body>
</html>
