<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M'Lunch</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <header>
        <div>
            <a href="/">Accueil</a>
            {% if request.session.client_id %}
                <a href="#">Livraison</a>
                <a href="/restaurant/">Restaurant</a>
            {% else %}
                <a href="/connexion/">Livraison</a>
                <a href="/connexion/">Restaurant</a>
            {% endif %} 
        </div>
    </header>

    <main>
        <section>
            <h2>Bienvenue chez M'Lunch ! Un délicieux repas vous attend.</h2>
            <p>Rapide, simple, délicieux.</p>
            
            <hr>
            
            <a href="{% url 'connexion' %}" style="display: inline-block; padding: 10px 20px; background-color: #ff6b35; color: white; border: none; border-radius: 5px; cursor: pointer; text-decoration: none;">Commencer →</a>
            
            <div id="restaurants-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <!-- Restaurant images will be loaded here -->
            </div>

            <!-- Delivery Zone Selector -->
            <div>
                <select id="view-selector">
                    <option value="">Choisir une option de livraison</option>
                    <option value="restaurants">Voir les restaurants sur la carte</option>
                    <option value="pickup-points">Voir les points de récupération</option>
                </select>
            </div>
            
            <!-- Map Container -->
            <div id="map-container" style="height: 400px;">
                <!-- Leaflet map will be loaded here -->
            </div>
            
            <!-- Delivery Zones Info -->
            <div>
                <h1>Nos zones de livraison :</h1>
                <ul>
                    <li>Point de recuperation</li>
                    <li>Faites-vous livrer votre envie du moment en un rien de temps.</li>
                </ul>
            </div>

            <!-- Partner Restaurants Section -->
            <div>
                <h1>Nos restaurants partenaires</h1>
                <div id="partner-restaurants">
                    <!-- Partner restaurants will be loaded here -->
                </div>
            </div>

        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map (centered on a default location)
           const map = L.map('map-container').setView([-18.8792, 47.5079], 13);
            
            // Add tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            // Immediately load pickup points by default
            loadPickupPoints();

            // Load restaurant images and partner restaurants
            fetch('/api/all_restaurants/')
                .then(response => response.json())
                .then(data => {
                    // Load restaurant images grid
                    const gridContainer = document.getElementById('restaurants-grid');
                    
                    data.features.forEach(restaurant => {
                        if (restaurant.properties.image_url) {
                            const img = document.createElement('img');
                            img.src = restaurant.properties.image_url;
                            img.alt = restaurant.properties.nom;
                            img.style.maxWidth = '200px';
                            img.style.margin = '5px';
                            gridContainer.appendChild(img);
                        }
                    });

                    // Load partner restaurants section
                    const partnerContainer = document.getElementById('partner-restaurants');
                    data.features.forEach(restaurant => {
                        const restaurantElement = document.createElement('div');
                        restaurantElement.innerHTML = `
                            <h2>${restaurant.properties.nom}</h2>
                            ${restaurant.properties.image_url ? `<img src="${restaurant.properties.image_url}" alt="${restaurant.properties.nom}" style="max-width: 300px;">` : ''}
                            <p>${restaurant.properties.description}</p>
                            <hr>
                        `;
                        partnerContainer.appendChild(restaurantElement);
                    });
                })
                .catch(error => {
                    console.error('Error fetching restaurants:', error);
                    const gridContainer = document.getElementById('restaurants-grid');
                    for (let i = 0; i < 3; i++) {
                        const placeholder = document.createElement('div');
                        placeholder.textContent = 'LE MANGO';
                        gridContainer.appendChild(placeholder);
                    }
                });

            // Map selector functionality
            const viewSelector = document.getElementById('view-selector');
            
            viewSelector.addEventListener('change', function() {
                const selectedOption = this.value;
                
                if (selectedOption === 'restaurants') {
                    loadRestaurants();
                } else if (selectedOption === 'pickup-points') {
                    loadPickupPoints();
                }
            });

            function loadRestaurants() {
                // DEBUG: Start loading restaurants
                console.debug('DEBUG: loadRestaurants called');
                // Clear existing markers
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                fetch('/api/all_restaurants/')
                    .then(response => response.json())
                    .then(data => {
                        console.debug('DEBUG: Data received from /api/all_restaurants/:', data);
                        if (!data.features || !Array.isArray(data.features)) {
                            console.warn('DEBUG: No features array in data:', data);
                        }
                        const bounds = [];
                        console.debug('DEBUG: Number of features:', data.features ? data.features.length : 0);
                        data.features && data.features.forEach(restaurant => {
                            if (restaurant.geometry?.coordinates) {
                                const [lng, lat] = restaurant.geometry.coordinates;
                                const marker = L.marker([lat, lng]).addTo(map);
                                marker.bindPopup(`<b>${restaurant.properties.nom}</b><br>${restaurant.properties.description}`);
                                bounds.push([lat, lng]);
                            } else {
                                console.warn('DEBUG: Skipping restaurant, missing geometry.coordinates:', restaurant);
                            }
                        });
                        console.debug('DEBUG: Final bounds array:', bounds);
                        if (bounds.length > 0) {
                            map.fitBounds(bounds, {padding: [50, 50]});
                        } else {
                            console.warn('DEBUG: No bounds to fit.');
                        }
                    });
            }

            function loadPickupPoints() {
                // DEBUG: Start loading pickup points
                console.debug('DEBUG: loadPickupPoints called');
                // Clear existing markers
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                fetch('/api/points_de_recuperation/')
                .then(response => {
                    console.debug('DEBUG: Response received from /api/points_de_recuperation/', response);
                    return response.json();
                })
                .then(data => {
                    console.debug('DEBUG: Data received:', data);
                    if (!data.features || !Array.isArray(data.features)) {
                        console.warn('DEBUG: No features array in data:', data);
                    }
                    const bounds = [];
                    console.debug('DEBUG: Number of features:', data.features ? data.features.length : 0);
                    data.features && data.features.forEach(point => {
                        console.debug('DEBUG: Processing point:', point);
                        if (point.geometry?.coordinates) {
                            const [lng, lat] = point.geometry.coordinates;
                            const marker = L.marker([lat, lng]).addTo(map);
                            marker.bindPopup(`<b>${point.properties.nom}</b>`);
                            bounds.push([lat, lng]);
                        } else {
                            console.warn('DEBUG: Skipping point, missing geometry.coordinates:', point);
                        }
                    });
                    console.debug('DEBUG: Final bounds array:', bounds);
                    if (bounds.length > 0) {
                        console.debug('DEBUG: Fitting map to bounds:', bounds);
                        map.fitBounds(bounds, {padding: [50, 50]});
                    } else {
                        console.warn('DEBUG: No bounds to fit.');
                    }
                })
                .catch(error => {
                    console.error('DEBUG: Error fetching pickup points:', error);
                });
            }
            
        });
    </script>
</body>
</html>